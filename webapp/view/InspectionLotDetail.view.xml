<mvc:View
    controllerName="com.kaar.qualityportal.controller.InspectionLotDetail"
    xmlns:mvc="sap.ui.core.mvc"
    xmlns="sap.m"
    xmlns:f="sap.f"
    xmlns:l="sap.ui.layout">
    <Page
        id="detailPage"
        title="{i18n>inspectionLotDetailPageTitle}"
        showNavButton="true"
        navButtonPress=".onNavBack"
        backgroundDesign="Solid">
        <headerContent>
            <Title text="{InspectionLot}" level="H2" class="sapUiTinyMarginEnd" />
        </headerContent>
        <content>
            <IconTabBar
                id="idIconTabBar"
                selectedKey="overview"
                expandable="false"
                class="sapUiResponsiveContentPadding">
                <items>
                    <IconTabFilter
                        icon="sap-icon://sys-enter-2"
                        text="{i18n>tabOverview}"
                        key="overview">
                        <VBox class="sapUiSmallMargin">
                            <Label text="{i18n>inspectionLot}:" />
                            <Text text="{InspectionLot}" class="sapUiSmallMarginBottom" />

                            <Label text="{i18n>materialNumber}:" />
                            <Text text="{MaterialNumber} - {MaterialDesc}" class="sapUiSmallMarginBottom" />

                            <Label text="{i18n>plant}:" />
                            <Text text="{Plant}" class="sapUiSmallMarginBottom" />

                            <Label text="{i18n>inspectionType}:" />
                            <Text text="{InspectionType}" class="sapUiSmallMarginBottom" />

                            <Label text="{i18n>lotQuantity}:" />
                            <Text text="{LotQuantity} {UoM}" class="sapUiSmallMarginBottom" />

                            <Label text="{i18n>usageDecisionCode}:" />
                            <Text text="{UsageDecisionCode}" />
                        </VBox>
                    </IconTabFilter>

                    <IconTabFilter
                        icon="sap-icon://form"
                        text="{i18n>tabResultRecords}"
                        key="resultRecords">
                        <VBox class="sapUiSmallMargin">
                            <!-- Header Panel (Always Visible) -->
                            <Panel headerText="{i18n>headerLotDetails}" class="sapUiSmallMarginBottom">
                                <content>
                                    <l:Grid defaultSpan="L12 M12 S12" hSpacing="2">
                                        <VBox alignItems="Center">
                                            <HBox>
                                                <Label text="{i18n>labelLotID}: " class="sapUiTinyMarginEnd" design="Bold"/>
                                                <Text text="{InspectionLot}"/>
                                            </HBox>
                                            <HBox>
                                                <Label text="{i18n>labelMaterial}: " class="sapUiTinyMarginEnd" design="Bold"/>
                                                <Text text="{MaterialDesc}"/>
                                            </HBox>
                                            <HBox>
                                                <Label text="{i18n>labelTotalQty}: " class="sapUiTinyMarginEnd" design="Bold"/>
                                                <Text text="{LotQuantity} {UoM}"/>
                                            </HBox>
                                        </VBox>
                                    </l:Grid>
                                </content>
                            </Panel>

                            <!-- NEW: Input Form (Visible only if Pending) -->
                            <Panel headerText="{i18n>headerEnterResults}" visible="{path: 'UsageDecisionCode', formatter: '.isLotPending'}">
                                <content>
                                    <VBox>
                                        <Label text="{i18n>labelGoodStock}" class="sapUiTinyMarginTop"/>
                                        <Input value="{viewModel>/goodStock}" type="Number" liveChange=".calculateTotal"/>
                                        
                                        <Label text="{i18n>labelBlockedStock}" class="sapUiTinyMarginTop"/>
                                        <Input value="{viewModel>/blockedStock}" type="Number" liveChange=".calculateTotal"/>
                                        
                                        <Label text="{i18n>labelReworkStock}" class="sapUiTinyMarginTop"/>
                                        <Input value="{viewModel>/reworkStock}" type="Number" liveChange=".calculateTotal"/>

                                        <HBox class="sapUiMediumMarginTop" alignItems="Center">
                                            <Label text="{i18n>labelTotalRecorded}" design="Bold" class="sapUiTinyMarginEnd"/>
                                            <Text text="{viewModel>/totalRecorded}" class="sapUiTinyMarginEnd"/>
                                        </HBox>

                                        <Button text="{i18n>btnSaveResults}" type="Emphasized" press=".onSaveResults" class="sapUiMediumMarginTop"/>
                                    </VBox>
                                </content>
                            </Panel>

                            <!-- OLD: Read-Only Table (Visible only if Locked) -->
                            <Table
                                id="resultRecordsTable"
                                inset="false"
                                items="/Z863_C_QRECORD"
                                visible="{path: 'UsageDecisionCode', formatter: '.isLotLocked'}"
                                class="sapUiSmallMarginTop">
                                <headerToolbar>
                                    <Toolbar>
                                        <Title text="{i18n>tabResultRecords} (Read-Only)"/>
                                    </Toolbar>
                                </headerToolbar>
                                <columns>
                                    <Column><Text text="{i18n>tableColOperationNo}" /></Column>
                                    <Column><Text text="{i18n>tableColCharNo}" /></Column>
                                    <Column><Text text="{i18n>tableColResultCode}" /></Column>
                                    <Column><Text text="{i18n>tableColStatus}" /></Column>
                                </columns>
                                <items>
                                    <ColumnListItem>
                                        <cells>
                                            <Text text="{OperationNo}" />
                                            <Text text="{CharacteristicNo}" />
                                            <Text text="{ResultCode}" />
                                            <Text text="{Status}" />
                                        </cells>
                                    </ColumnListItem>
                                </items>
                            </Table>
                        </VBox>
                    </IconTabFilter>

                    <IconTabFilter
                        icon="sap-icon://decision"
                        text="{i18n>tabUsageDecision}"
                        key="usageDecision">
                        <VBox class="sapUiSmallMargin">
                             <!-- Header Panel (Always Visible) -->
                            <Panel headerText="{i18n>headerLotDecision}" class="sapUiSmallMarginBottom">
                                <content>
                                    <l:Grid defaultSpan="L12 M12 S12" hSpacing="2">
                                        <VBox alignItems="Center">
                                            <HBox>
                                                <Label text="{i18n>labelLotID}: " class="sapUiTinyMarginEnd" design="Bold"/>
                                                <Text text="{InspectionLot}"/>
                                            </HBox>
                                            <HBox>
                                                <Label text="{i18n>labelMaterial}: " class="sapUiTinyMarginEnd" design="Bold"/>
                                                <Text text="{MaterialDesc}"/>
                                            </HBox>
                                            <HBox>
                                                <Label text="{i18n>labelTotalQty}: " class="sapUiTinyMarginEnd" design="Bold"/>
                                                <Text text="{LotQuantity} {UoM}"/>
                                            </HBox>
                                        </VBox>
                                    </l:Grid>
                                </content>
                            </Panel>

                            <!-- NEW: Decision Buttons (Visible only if Pending) -->
                            <Panel headerText="{i18n>headerMakeDecision}" visible="{path: 'UsageDecisionCode', formatter: '.isLotPending'}">
                                <content>
                                    <VBox alignItems="Center" class="sapUiMediumMargin">
                                        <Title text="{i18n>questionQualityChecks}" level="H4" class="sapUiMediumMarginBottom"/>
                                        <HBox>
                                            <Button text="{i18n>btnAccept}" type="Accept" press=".onAcceptLot" class="sapUiSmallMarginEnd" width="150px"/>
                                            <Button text="{i18n>btnReject}" type="Reject" press=".onRejectLot" width="150px"/>
                                        </HBox>
                                    </VBox>
                                </content>
                            </Panel>

                            <!-- OLD: Read-Only Table (Visible only if Locked) -->
                            <Table
                                id="usageDecisionTable"
                                inset="false"
                                items="/Z863_C_QUSAGE"
                                visible="{path: 'UsageDecisionCode', formatter: '.isLotLocked'}"
                                class="sapUiSmallMarginTop">
                                <headerToolbar>
                                    <Toolbar>
                                        <Title text="{i18n>tabUsageDecision} (Read-Only)"/>
                                    </Toolbar>
                                </headerToolbar>
                                <columns>
                                    <Column><Text text="{i18n>tableColUDType}" /></Column>
                                    <Column><Text text="{i18n>tableColUDCode}" /></Column>
                                    <Column><Text text="{i18n>tableColDecisionBy}" /></Column>
                                    <Column><Text text="{i18n>tableColDecisionDate}" /></Column>
                                    <Column><Text text="{i18n>tableColQualityScore}" /></Column>
                                </columns>
                                <items>
                                    <ColumnListItem>
                                        <cells>
                                            <Text text="{InspectionLotType}" />
                                            <Text text="{UsageDecisionCode}" />
                                            <Text text="{DecisionBy}" />
                                            <Text text="{path: 'DecisionDate', type: 'sap.ui.model.type.Date', formatOptions: { pattern: 'yyyy-MM-dd' }}" />
                                            <Text text="{QualityScore}" />
                                        </cells>
                                    </ColumnListItem>
                                </items>
                            </Table>
                        </VBox>
                    </IconTabFilter>
                </items>
            </IconTabBar>
        </content>
    </Page>
</mvc:View>
